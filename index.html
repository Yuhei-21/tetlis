<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
  <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div id="app" >
    {{ message }}
    {{text}}
    <button v-on:click="onClick">ボタン</button>
    <input v-model="text" type="text">
    <div class="line" v-for="line in field">
      <div class="block" v-for="block in line">
        <div v-if="block == 0" class="blank inline-block">

        </div>
        <div v-else-if="block == 1" class="fixed-block inline-block">
          
        </div>
        <div v-else-if="block == 2" class="move-block inline-block">
          
        </div>
        <div v-else-if="block == 9" class="frame-block inline-block">
          
        </div>
      </div>
    </div>
  </div>
</body>

<script>

  var app = new Vue({
    el: '#app',
    data: {
      message: 'Hello Vue!',
      text: "",
      field: [
        [9,0,0,0,2,2,2,2,0,0,0,9],
        [9,0,0,0,0,0,0,0,0,0,0,9],
        [9,0,0,0,0,0,0,0,0,0,0,9],
        [9,0,0,0,0,0,0,0,0,0,0,9],
        [9,0,0,0,0,0,0,0,0,0,0,9],
        [9,0,0,0,0,0,0,0,0,0,0,9],
        [9,0,0,0,0,0,0,0,0,0,0,9],
        [9,0,0,0,0,0,0,0,0,0,0,9],
        [9,0,0,0,0,0,0,0,0,0,0,9],
        [9,0,0,0,0,0,0,0,0,0,0,9],
        [9,0,0,0,0,0,0,0,0,0,0,9],
        [9,0,0,0,0,0,0,0,0,0,0,9],
        [9,0,0,0,0,0,0,0,0,0,0,9],
        [9,0,0,0,0,0,0,0,0,0,0,9],
        [9,0,0,0,0,0,0,0,0,0,0,9],
        [9,0,0,0,0,0,0,0,0,0,0,9],
        [9,0,0,0,0,0,0,0,0,0,0,9],
        [9,0,0,0,0,0,0,0,0,0,0,9],
        [9,0,0,0,0,0,0,0,0,0,0,9],
        [9,0,1,0,0,0,1,0,0,0,0,9],
        [9,1,1,1,1,1,1,0,0,0,0,9],
        [9,9,9,9,9,9,9,9,9,9,9,9],
      ]
    },
    created(){
      setInterval(this.BlockMove,500)
      const self = this
      document.addEventListener('keydown', (event) => {
        var keyName = event.key;
          if(keyName == "h"){
            self.RightMove()
          }
          if(keyName == "g"){
            self.LeftMove()
          }
          if(keyName == "b"){
            self.DownMove()
          }
      });
    },
    methods:{
      onClick(){
        //dataの中身を参照するにはthis.と参照しなければいけない
        console.log("ボタンが押されたことを検出",this.text)
      },
      stopAllBlock(){
        // console.log("called")
        for(let i=0; i<this.field.length; i++){
          for(let j=0; j<this.field[i].length; j++){
            if(this.field[i][j] == 2){
              this.field[i][j] = 1
            }
          }
        }
        return this.field
      },
      checkRowClear(){
        let isClear = true
        for(let i=0; i<this.field.length; i++){
          for(let j=0; j<this.field[i].length; j++){
            if(this.field[i][j] != 1 && this.field[i][j] != 9){
              isClear = false
            }
          }
        }
        if(isClear){
            console.log("フラグが立っています")
        }else{
          console.log("フラグが立っていません")
        }
      },
      BlockMove(){
        let tmpfield = [
          [9,0,0,0,0,0,0,0,0,0,0,9],
          [9,0,0,0,0,0,0,0,0,0,0,9],
          [9,0,0,0,0,0,0,0,0,0,0,9],
          [9,0,0,0,0,0,0,0,0,0,0,9],
          [9,0,0,0,0,0,0,0,0,0,0,9],
          [9,0,0,0,0,0,0,0,0,0,0,9],
          [9,0,0,0,0,0,0,0,0,0,0,9],
          [9,0,0,0,0,0,0,0,0,0,0,9],
          [9,0,0,0,0,0,0,0,0,0,0,9],
          [9,0,0,0,0,0,0,0,0,0,0,9],
          [9,0,0,0,0,0,0,0,0,0,0,9],
          [9,0,0,0,0,0,0,0,0,0,0,9],
          [9,0,0,0,0,0,0,0,0,0,0,9],
          [9,0,0,0,0,0,0,0,0,0,0,9],
          [9,0,0,0,0,0,0,0,0,0,0,9],
          [9,0,0,0,0,0,0,0,0,0,0,9],
          [9,0,0,0,0,0,0,0,0,0,0,9],
          [9,0,0,0,0,0,0,0,0,0,0,9],
          [9,0,0,0,0,0,0,0,0,0,0,9],
          [9,0,0,0,0,0,0,0,0,0,0,9],
          [9,0,0,0,0,0,0,0,0,0,0,9],
          [9,9,9,9,9,9,9,9,9,9,9,9],
        ]
        let tmpfield2 = [
          [9,0,0,0,0,0,0,0,0,0,0,9],
          [9,0,0,0,0,0,0,0,0,0,0,9],
          [9,0,0,0,0,0,0,0,0,0,0,9],
          [9,0,0,0,0,0,0,0,0,0,0,9],
          [9,0,0,0,0,0,0,0,0,0,0,9],
          [9,0,0,0,0,0,0,0,0,0,0,9],
          [9,0,0,0,0,0,0,0,0,0,0,9],
          [9,0,0,0,0,0,0,0,0,0,0,9],
          [9,0,0,0,0,0,0,0,0,0,0,9],
          [9,0,0,0,0,0,0,0,0,0,0,9],
          [9,0,0,0,0,0,0,0,0,0,0,9],
          [9,0,0,0,0,0,0,0,0,0,0,9],
          [9,0,0,0,0,0,0,0,0,0,0,9],
          [9,0,0,0,0,0,0,0,0,0,0,9],
          [9,0,0,0,0,0,0,0,0,0,0,9],
          [9,0,0,0,0,0,0,0,0,0,0,9],
          [9,0,0,0,0,0,0,0,0,0,0,9],
          [9,0,0,0,0,0,0,0,0,0,0,9],
          [9,0,0,0,0,0,0,0,0,0,0,9],
          [9,0,0,0,0,0,0,0,0,0,0,9],
          [9,0,0,0,0,0,0,0,0,0,0,9],
          [9,9,9,9,9,9,9,9,9,9,9,9],
        ]

        let isHit = false
        //まず今回の移動で当たっているかを判断する
        for(let i=0; i<this.field.length; i++){
          for(let j=0; j<this.field[i].length; j++){
            if(this.field[i][j] == 2){
              tmpfield[i+1][j] = this.field[i][j]
            }
          }
        }

        for(let i=0; i<this.field.length; i++){
          for(let j=0; j<this.field[i].length; j++){
            if(tmpfield[i][j]==2 && (this.field[i][j]==1 || this.field[i][j]==9)){
              //ここで当たったという情報を変数に書き込む ループを強制的に抜ける
              isHit = true
              break
            }
          }
        }

        if(isHit){
          //当たっていればすべてを固める
          this.stopAllBlock()
          //物が1に変わったタイミング
          //この中でもし、1列に1か9しか存在しなければ
          //ブロックが消えたと判断して、1列を削除
          //スコアに加点する
          this.checkRowClear()
        }else{
          for(let i=0; i<this.field.length; i++){
            for(let j=0; j<this.field[i].length; j++){
              if(this.field[i][j] == 2){
                tmpfield2[i+1][j] = this.field[i][j]
              }else if(this.field[i][j] == 1){
                tmpfield2[i][j] = this.field[i][j]
              }else if(this.field[i][j] == 9){
                tmpfield2[i][j] = this.field[i][j]
              }
            }
          }
          this.field = tmpfield2
        }


        this.$forceUpdate()
      },
      RightMove(){
        let tmpfield = [
          [9,0,0,0,0,0,0,0,0,0,0,9],
          [9,0,0,0,0,0,0,0,0,0,0,9],
          [9,0,0,0,0,0,0,0,0,0,0,9],
          [9,0,0,0,0,0,0,0,0,0,0,9],
          [9,0,0,0,0,0,0,0,0,0,0,9],
          [9,0,0,0,0,0,0,0,0,0,0,9],
          [9,0,0,0,0,0,0,0,0,0,0,9],
          [9,0,0,0,0,0,0,0,0,0,0,9],
          [9,0,0,0,0,0,0,0,0,0,0,9],
          [9,0,0,0,0,0,0,0,0,0,0,9],
          [9,0,0,0,0,0,0,0,0,0,0,9],
          [9,0,0,0,0,0,0,0,0,0,0,9],
          [9,0,0,0,0,0,0,0,0,0,0,9],
          [9,0,0,0,0,0,0,0,0,0,0,9],
          [9,0,0,0,0,0,0,0,0,0,0,9],
          [9,0,0,0,0,0,0,0,0,0,0,9],
          [9,0,0,0,0,0,0,0,0,0,0,9],
          [9,0,0,0,0,0,0,0,0,0,0,9],
          [9,0,0,0,0,0,0,0,0,0,0,9],
          [9,0,0,0,0,0,0,0,0,0,0,9],
          [9,0,0,0,0,0,0,0,0,0,0,9],
          [9,9,9,9,9,9,9,9,9,9,9,9],
        ]
        let isHit = false
        for(let i=0; i<this.field.length; i++){
          for(let j=0; j<this.field[i].length; j++){
            if(this.field[i][j] == 2){
              tmpfield[i][j+1] = this.field[i][j]
            }
          }
        }

        for(let i=0; i<this.field.length; i++){
          for(let j=0; j<this.field[i].length; j++){
            if(tmpfield[i][j]==2 && (this.field[i][j]==1 || this.field[i][j]==9)){
              isHit = true
              break
            }
          }
        }

        if(isHit == false){
          for(let i=0; i<this.field.length; i++){
            for(let j=0; j<this.field[i].length; j++){
              if(this.field[i][j] == 2){
                if(i < this.field.length-1){
                  tmpfield[i][j+1] = this.field[i][j]
                }
              }else if(this.field[i][j] == 1){
                tmpfield[i][j] = this.field[i][j]
              }
            }
          }
          this.field = tmpfield
        }
        this.$forceUpdate()
      },
      LeftMove(){
        let tmpfield = [
          [9,0,0,0,0,0,0,0,0,0,0,9],
          [9,0,0,0,0,0,0,0,0,0,0,9],
          [9,0,0,0,0,0,0,0,0,0,0,9],
          [9,0,0,0,0,0,0,0,0,0,0,9],
          [9,0,0,0,0,0,0,0,0,0,0,9],
          [9,0,0,0,0,0,0,0,0,0,0,9],
          [9,0,0,0,0,0,0,0,0,0,0,9],
          [9,0,0,0,0,0,0,0,0,0,0,9],
          [9,0,0,0,0,0,0,0,0,0,0,9],
          [9,0,0,0,0,0,0,0,0,0,0,9],
          [9,0,0,0,0,0,0,0,0,0,0,9],
          [9,0,0,0,0,0,0,0,0,0,0,9],
          [9,0,0,0,0,0,0,0,0,0,0,9],
          [9,0,0,0,0,0,0,0,0,0,0,9],
          [9,0,0,0,0,0,0,0,0,0,0,9],
          [9,0,0,0,0,0,0,0,0,0,0,9],
          [9,0,0,0,0,0,0,0,0,0,0,9],
          [9,0,0,0,0,0,0,0,0,0,0,9],
          [9,0,0,0,0,0,0,0,0,0,0,9],
          [9,0,0,0,0,0,0,0,0,0,0,9],
          [9,0,0,0,0,0,0,0,0,0,0,9],
          [9,9,9,9,9,9,9,9,9,9,9,9],
        ]
        let isHit = false
        for(let i=0; i<this.field.length; i++){
          for(let j=0; j<this.field[i].length; j++){
            if(this.field[i][j] == 2){
              tmpfield[i][j-1] = this.field[i][j]
            }
          }
        }

        for(let i=0; i<this.field.length; i++){
          for(let j=0; j<this.field[i].length; j++){
            if(tmpfield[i][j]==2 && (this.field[i][j]==1 || this.field[i][j]==9)){
              isHit = true
              break
            }
          }
        }

        if(isHit == false){
          for(let i=0; i<this.field.length; i++){
            for(let j=0; j<this.field[i].length; j++){
              if(this.field[i][j] == 2){
                if(i < this.field.length-1){
                  tmpfield[i][j-1] = this.field[i][j]
                }
              }else if(this.field[i][j] == 1){
                tmpfield[i][j] = this.field[i][j]
              }
            }
          }
          this.field = tmpfield
        }
        this.$forceUpdate()
      },
      DownMove(){
        let tmpfield = [
          [9,0,0,0,0,0,0,0,0,0,0,9],
          [9,0,0,0,0,0,0,0,0,0,0,9],
          [9,0,0,0,0,0,0,0,0,0,0,9],
          [9,0,0,0,0,0,0,0,0,0,0,9],
          [9,0,0,0,0,0,0,0,0,0,0,9],
          [9,0,0,0,0,0,0,0,0,0,0,9],
          [9,0,0,0,0,0,0,0,0,0,0,9],
          [9,0,0,0,0,0,0,0,0,0,0,9],
          [9,0,0,0,0,0,0,0,0,0,0,9],
          [9,0,0,0,0,0,0,0,0,0,0,9],
          [9,0,0,0,0,0,0,0,0,0,0,9],
          [9,0,0,0,0,0,0,0,0,0,0,9],
          [9,0,0,0,0,0,0,0,0,0,0,9],
          [9,0,0,0,0,0,0,0,0,0,0,9],
          [9,0,0,0,0,0,0,0,0,0,0,9],
          [9,0,0,0,0,0,0,0,0,0,0,9],
          [9,0,0,0,0,0,0,0,0,0,0,9],
          [9,0,0,0,0,0,0,0,0,0,0,9],
          [9,0,0,0,0,0,0,0,0,0,0,9],
          [9,0,0,0,0,0,0,0,0,0,0,9],
          [9,0,0,0,0,0,0,0,0,0,0,9],
          [9,9,9,9,9,9,9,9,9,9,9,9],
        ]
        let isHit = false
        for(let i=0; i<this.field.length; i++){
          for(let j=0; j<this.field[i].length; j++){
            if(this.field[i][j] == 2){
              tmpfield[i+1][j] = this.field[i][j]
            }
          }
        }

        for(let i=0; i<this.field.length; i++){
          for(let j=0; j<this.field[i].length; j++){
            if(tmpfield[i][j]==2 && (this.field[i][j]==1 || this.field[i][j]==9)){
              isHit = true
              break
            }
          }
        }

        if(isHit == false){
          for(let i=0; i<this.field.length; i++){
            for(let j=0; j<this.field[i].length; j++){
              if(this.field[i][j] == 2){
                if(i < this.field.length-1){
                  tmpfield[i+1][j] = this.field[i][j]
                }
              }else if(this.field[i][j] == 1){
                tmpfield[i][j] = this.field[i][j]
              }
            }
          }
          this.field = tmpfield
        }
        this.$forceUpdate()
      }
    }
  })
</script>
</html>